<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูููุฏ ุงูุฃุณุฆูุฉ ุงูุฐูู - ูุฏุนูู ุจู Gemini AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .ai-badge {
            background: linear-gradient(45deg, #4285f4, #34a853, #fbbc05, #ea4335);
            background-size: 400% 400%;
            animation: gradient 3s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .loading-dots {
            display: inline-block;
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .question-card {
            transition: all 0.3s ease;
            border-right: 4px solid #667eea;
        }
        
        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .success-animation {
            animation: successPulse 0.6s ease-in-out;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .error-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-8">
        <div class="container mx-auto px-4 text-center">
            <div class="flex items-center justify-center mb-4">
                <div class="ai-badge text-white px-4 py-2 rounded-full text-sm font-semibold mr-4">
                    ๐ค ูุฏุนูู ุจู Gemini AI
                </div>
                <h1 class="text-4xl font-bold">๐ ูููุฏ ุงูุฃุณุฆูุฉ ุงูุฐูู</h1>
            </div>
            <p class="text-xl opacity-90">ุฃุฏุงุฉ ูุชุทูุฑุฉ ูุฅูุดุงุก ุฃุณุฆูุฉ ุชุนููููุฉ ุนุงููุฉ ุงูุฌูุฏุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู</p>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Status Indicator -->
        <div id="statusIndicator" class="hidden mb-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                <div class="text-blue-600 text-2xl mb-2">๐</div>
                <p class="text-blue-800 font-semibold">ุฌุงุฑู ุงูุงุชุตุงู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู<span class="loading-dots"></span></p>
                <p class="text-blue-600 text-sm mt-1">ูุฑุฌู ุงูุงูุชุธุงุฑุ ูุฏ ุชุณุชุบุฑู ุงูุนูููุฉ ุฏูููุฉ ูุงุญุฏุฉ</p>
            </div>
        </div>

        <!-- Input Form -->
        <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">๐ ุฅุนุฏุงุฏุงุช ุชูููุฏ ุงูุฃุณุฆูุฉ</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">๐ ุงูููุถูุน ุฃู ุงููุงุฏุฉ *</label>
                    <input type="text" id="subject" placeholder="ูุซุงู: ุงูุฑูุงุถูุงุชุ ุงูููุฒูุงุกุ ุงูุชุงุฑูุฎ ุงูุฅุณูุงูู..." 
                           class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <p class="text-sm text-gray-500 mt-1">ูู ูุญุฏุฏุงู ูุฏุฑ ุงูุฅููุงู (ูุซู: ุงูุฌุจุฑุ ุงูููููุงุก ุงูุนุถููุฉุ ุชุงุฑูุฎ ุงูุฏููุฉ ุงูุนุจุงุณูุฉ)</p>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">๐ฏ ุงููุณุชูู ุงูุชุนูููู *</label>
                    <select id="level" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">ุงุฎุชุฑ ุงููุณุชูู</option>
                        <option value="ุงุจุชุฏุงุฆู">ุงุจุชุฏุงุฆู (6-12 ุณูุฉ)</option>
                        <option value="ูุชูุณุท">ูุชูุณุท (12-15 ุณูุฉ)</option>
                        <option value="ุซุงููู">ุซุงููู (15-18 ุณูุฉ)</option>
                        <option value="ุฌุงูุนู">ุฌุงูุนู (18+ ุณูุฉ)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">โ ููุน ุงูุฃุณุฆูุฉ *</label>
                    <select id="questionType" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">ุงุฎุชุฑ ููุน ุงูุฃุณุฆูุฉ</option>
                        <option value="ุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ">ุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ (4 ุฎูุงุฑุงุช)</option>
                        <option value="ุตุญ ุฃู ุฎุทุฃ">ุตุญ ุฃู ุฎุทุฃ (ูุน ุงูุชูุณูุฑ)</option>
                        <option value="ุฃุณุฆูุฉ ููุงููุฉ">ุฃุณุฆูุฉ ููุงููุฉ (ุดุฑุญ ููุตู)</option>
                        <option value="ุฃุณุฆูุฉ ูุตูุฑุฉ">ุฃุณุฆูุฉ ูุตูุฑุฉ (ุฅุฌุงุจุงุช ูุฎุชุตุฑุฉ)</option>
                        <option value="ูุชููุนุฉ">ูุชููุนุฉ (ูุฒูุฌ ูู ุงูุฃููุงุน)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">๐ข ุนุฏุฏ ุงูุฃุณุฆูุฉ</label>
                    <select id="questionCount" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="5">5 ุฃุณุฆูุฉ</option>
                        <option value="10" selected>10 ุฃุณุฆูุฉ</option>
                        <option value="15">15 ุณุคุงู</option>
                        <option value="20">20 ุณุคุงู</option>
                    </select>
                </div>
            </div>
            
            <div class="mt-6">
                <label class="block text-gray-700 font-semibold mb-2">๐ ุชูุงุตูู ุฅุถุงููุฉ (ุงุฎุชูุงุฑู)</label>
                <textarea id="additionalDetails" rows="3" placeholder="ุฃุถู ุฃู ุชูุงุตูู ูุญุฏุฏุฉ ูุซู: ุฑูุฒ ุนูู ุงููุตู ุงูุซุงูุซุ ุฃุณุฆูุฉ ุชุทุจูููุฉุ ูุณุชูู ุตุนูุจุฉ ูุชูุณุท..."
                          class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
            </div>
            
            <div class="text-center mt-8">
                <button onclick="generateQuestions()" id="generateBtn" 
                        class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-4 rounded-lg font-semibold text-lg hover:from-blue-700 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                    ๐ ุชูููุฏ ุงูุฃุณุฆูุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-8">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <h2 class="text-2xl font-bold text-gray-800">โจ ุงูุฃุณุฆูุฉ ุงููููุฏุฉ</h2>
                        <div id="aiIndicator" class="mr-4 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">
                            ๐ค ูููุฏ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู
                        </div>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="editQuestions()" class="bg-orange-500 text-white px-3 py-2 rounded-lg hover:bg-orange-600 transition-colors text-sm">
                            โ๏ธ ุชุนุฏูู
                        </button>
                        <button onclick="formatQuestions()" class="bg-indigo-500 text-white px-3 py-2 rounded-lg hover:bg-indigo-600 transition-colors text-sm">
                            ๐จ ุชูุณูู
                        </button>
                        <button onclick="customizeHeader()" class="bg-pink-500 text-white px-3 py-2 rounded-lg hover:bg-pink-600 transition-colors text-sm">
                            ๐ ุชุฑููุณุฉ
                        </button>
                        <button onclick="copyAllQuestions()" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm">
                            ๐ ูุณุฎ
                        </button>
                        <button onclick="downloadQuestions()" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                            ๐พ ุชุญููู
                        </button>
                        <button onclick="createExamPaper()" class="bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 transition-colors font-semibold text-sm">
                            ๐ ูุฑูุฉ ุงูุชุญุงู
                        </button>
                    </div>
                </div>
                
                <div id="questionsContainer" class="space-y-6">
                    <!-- Questions will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Error Section -->
        <div id="errorSection" class="hidden">
            <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center error-shake">
                <div class="text-red-600 text-6xl mb-4">โ๏ธ</div>
                <h3 class="text-xl font-bold text-red-800 mb-2">ูุดู ูู ุงูุงุชุตุงู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู</h3>
                <p class="text-red-600 mb-4" id="errorMessage"></p>
                <div class="space-y-3">
                    <button onclick="generateQuestions()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">
                        ๐ ุฅุนุงุฏุฉ ุงููุญุงููุฉ
                    </button>
                    <p class="text-sm text-red-500">ุชุฃูุฏ ูู ุตุญุฉ ููุชุงุญ API ุฃู ุฌุฑุจ ูุฑุฉ ุฃุฎุฑู ุจุนุฏ ูููู</p>
                </div>
            </div>
        </div>

        <!-- Edit Questions Modal -->
        <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-bold text-gray-800">โ๏ธ ุชุนุฏูู ุงูุฃุณุฆูุฉ</h2>
                        <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">ร</button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="editQuestionsContainer" class="space-y-6">
                        <!-- Editable questions will be displayed here -->
                    </div>
                    <div class="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
                        <button onclick="closeEditModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            ุฅูุบุงุก
                        </button>
                        <button onclick="saveEditedQuestions()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            ๐พ ุญูุธ ุงูุชุบููุฑุงุช
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Format Modal -->
        <div id="formatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-bold text-gray-800">๐จ ุชูุณูู ุงูุฃุณุฆูุฉ</h2>
                        <button onclick="closeFormatModal()" class="text-gray-500 hover:text-gray-700 text-2xl">ร</button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">ููุท ุงูุนุฑุถ</label>
                            <select id="displayStyle" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="cards">ุจุทุงูุงุช (ุงูุชุฑุงุถู)</option>
                                <option value="list">ูุงุฆูุฉ ุจุณูุทุฉ</option>
                                <option value="compact">ูุถุบูุท</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">ุญุฌู ุงูุฎุท</label>
                            <select id="fontSize" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="text-sm">ุตุบูุฑ</option>
                                <option value="text-base" selected>ูุชูุณุท</option>
                                <option value="text-lg">ูุจูุฑ</option>
                                <option value="text-xl">ูุจูุฑ ุฌุฏุงู</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">ููู ุงูุญุฏูุฏ</label>
                            <select id="borderColor" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="border-blue-400" selected>ุฃุฒุฑู</option>
                                <option value="border-green-400">ุฃุฎุถุฑ</option>
                                <option value="border-purple-400">ุจููุณุฌู</option>
                                <option value="border-red-400">ุฃุญูุฑ</option>
                                <option value="border-gray-400">ุฑูุงุฏู</option>
                            </select>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="showNumbers" checked class="ml-2">
                            <label for="showNumbers" class="text-gray-700">ุฅุธูุงุฑ ุฃุฑูุงู ุงูุฃุณุฆูุฉ</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="showExplanations" checked class="ml-2">
                            <label for="showExplanations" class="text-gray-700">ุฅุธูุงุฑ ุงูุชูุณูุฑุงุช</label>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
                        <button onclick="closeFormatModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            ุฅูุบุงุก
                        </button>
                        <button onclick="applyFormatting()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            ๐จ ุชุทุจูู ุงูุชูุณูู
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header Customization Modal -->
        <div id="headerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-bold text-gray-800">๐ ุชุฎุตูุต ุงูุชุฑููุณุฉ</h2>
                        <button onclick="closeHeaderModal()" class="text-gray-500 hover:text-gray-700 text-2xl">ร</button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">ุงุณู ุงููุคุณุณุฉ</label>
                            <input type="text" id="institutionName" value="ุงููุคุณุณุฉ ุงูุชุนููููุฉ" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">ุงุณู ุงููุนูู/ุงูุฃุณุชุงุฐ</label>
                            <input type="text" id="teacherName" placeholder="ุงุฎุชูุงุฑู" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">ูุฏุฉ ุงูุงูุชุญุงู</label>
                            <select id="examDuration" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="ุณุงุนุฉ ูุงุญุฏุฉ">ุณุงุนุฉ ูุงุญุฏุฉ</option>
                                <option value="ุณุงุนุฉ ููุตู">ุณุงุนุฉ ููุตู</option>
                                <option value="ุณุงุนุชุงู" selected>ุณุงุนุชุงู</option>
                                <option value="ุซูุงุซ ุณุงุนุงุช">ุซูุงุซ ุณุงุนุงุช</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">ุฏุฑุฌุฉ ุงูุณุคุงู ุงููุงุญุฏ</label>
                            <select id="questionScore" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="2">2 ุฏุฑุฌุฉ</option>
                                <option value="3">3 ุฏุฑุฌุงุช</option>
                                <option value="5" selected>5 ุฏุฑุฌุงุช</option>
                                <option value="10">10 ุฏุฑุฌุงุช</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">ุชุนูููุงุช ุฅุถุงููุฉ</label>
                            <textarea id="additionalInstructions" rows="3" placeholder="ุฃุถู ุฃู ุชุนูููุงุช ุฎุงุตุฉ ููุงูุชุญุงู..." class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
                        <button onclick="closeHeaderModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            ุฅูุบุงุก
                        </button>
                        <button onclick="saveHeaderSettings()" class="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 transition-colors">
                            ๐ ุญูุธ ุงูุฅุนุฏุงุฏุงุช
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exam Paper Section -->
        <div id="examPaperSection" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">๐ ูุฑูุฉ ุงูุงูุชุญุงู</h2>
                    <div class="flex gap-3">
                        <button onclick="printExam()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            ๐จ๏ธ ุทุจุงุนุฉ
                        </button>
                        <button onclick="downloadExamPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                            ๐ ุชุญููู
                        </button>
                    </div>
                </div>
                
                <div id="examPaperContent" class="bg-white border-2 border-gray-300 rounded-lg p-8">
                    <!-- Exam content will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="gradient-bg text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="opacity-90">๐ค ูุฏุนูู ุจุชูููุฉ Gemini AI ูู Google โข ุฃุฏุงุฉ ุชุนููููุฉ ูุชูุฏูุฉ</p>
        </div>
    </footer>

    <script>
        // AI Configuration
        const GEMINI_API_KEY = 'AIzaSyC7MgGE_ygA_T16_KBzZbJJxEQvqu7cfe8';
        const DEEPAI_API_KEY = '35b2868b-4367-4cb4-8d4a-bcb4e585d2ef';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent';
        const DEEPAI_API_URL = 'https://api.deepai.org/api/text-generator';

        let generatedQuestions = [];
        let isAIGenerated = false;
        let aiProvider = 'none';

        // Ultra-Enhanced AI Prompt Builder with bulletproof formatting
        function buildAdvancedPrompt(subject, level, questionType, questionCount, additionalDetails) {
            const prompt = `
ุฃูุช ูุธุงู ุฐูู ูุชุฎุตุต ูู ุฅูุดุงุก ุฃุณุฆูุฉ ุชุนููููุฉ ูุซุงููุฉ. ูููุชู ุงููุญูุฏุฉ: ุฅูุดุงุก ${questionCount} ุฃุณุฆูุฉ ูุงููุฉ ูููุณูุฉ ุจุฏูุฉ ุชุงูุฉ.

๐ฏ ุงูุจูุงูุงุช ุงููุทููุจุฉ:
ุงูููุถูุน: ${subject}
ุงููุณุชูู: ${level}
ุงูููุน: ${questionType}
ุงูุนุฏุฏ: ${questionCount} ุฃุณุฆูุฉ ุจุงูุถุจุท
${additionalDetails ? `ุงูุชูุงุตูู: ${additionalDetails}` : ''}

โ๏ธ ููุงุนุฏ ุตุงุฑูุฉ - ูุง ุงุณุชุซูุงุกุงุช:
1. ุฃูุดุฆ ${questionCount} ุฃุณุฆูุฉ ููุท - ูุง ุฃูุซุฑ ููุง ุฃูู
2. ูู ุณุคุงู ูุฌุจ ุฃู ูููู ููุชูู 100%
3. ุงุณุชุฎุฏู ุงูุชูุณูู ุงููุญุฏุฏ ุจุงูุถุจุท
4. ูุตู ูู ุณุคุงู ุจู "---" ุนูู ุณุทุฑ ูููุตู
5. ูุง ุชูุชุจ ุฃู ูุต ุฅุถุงูู ุฎุงุฑุฌ ุงูุฃุณุฆูุฉ
6. ูุง ุชุณุชุฎุฏู ุฑููุฒ ูุซู * ุฃู # ุฃู ุฃุฑูุงู
7. ุงูุชุจ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ููุท

๐ฏ ุงูุชูุณูู ุงูุฅุฌุจุงุฑู (ุงุชุจุนู ุญุฑููุงู):
${getStrictPromptFormat(questionType)}

โ ูุซุงู ูุซุงูู ููุชูุณูู:
ุงูุณุคุงู: ูู ุงูุฌููุฉ "ูุชุจ ุงูุทุงูุจ ุงูุฏุฑุณ"ุ ูุง ูู ุงููุงุนูุ
ุฃ) ูุชุจ
ุจ) ุงูุทุงูุจ
ุฌ) ุงูุฏุฑุณ
ุฏ) ุงูุฌููุฉ
ุงูุฅุฌุงุจุฉ: ุจ
ุงูุชูุณูุฑ: ุงููุงุนู ูู ูู ูุงู ุจุงููุนูุ ูุงูุทุงูุจ ูู ูู ูุงู ุจูุนู ุงููุชุงุจุฉ
---

๐จ ุชุญุฐูุฑ ููุงุฆู:
- ูุฌุจ ุฃู ูููู ูู ุณุคุงู ููุชูู ุจุฌููุน ุนูุงุตุฑู
- ูุฌุจ ุฃู ุชููู ุฌููุน ุงูุฎูุงุฑุงุช ูุงุถุญุฉ ูููุทููุฉ
- ูุฌุจ ุฃู ุชููู ุงูุฅุฌุงุจุฉ ุตุญูุญุฉ ููุญุฏุฏุฉ
- ูุฌุจ ุฃู ูููู ุงูุชูุณูุฑ ูููุฏ ูููุตู

ุงุจุฏุฃ ุงูุขู - ุฃูุดุฆ ${questionCount} ุฃุณุฆูุฉ ููุชููุฉ:`;

            return prompt;
        }

        // Ultra-Strict Format specifications - No room for error
        function getStrictPromptFormat(questionType) {
            switch(questionType) {
                case 'ุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ':
                    return `
ุงูุณุคุงู: [ูุต ุงูุณุคุงู ุจูุถูุญ ุชุงู ูุน ุนูุงูุฉ ุงุณุชููุงู]
ุฃ) [ุฎูุงุฑ ุฎุงุทุฆ ููุทูู]
ุจ) [ุฎูุงุฑ ุฎุงุทุฆ ููุทูู]
ุฌ) [ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ุงููุญูุฏุฉ]
ุฏ) [ุฎูุงุฑ ุฎุงุทุฆ ููุทูู]
ุงูุฅุฌุงุจุฉ: ุฌ
ุงูุชูุณูุฑ: [ุดุฑุญ ูุงุถุญ ูููุตู ูุณุจุจ ุตุญุฉ ุงูุฅุฌุงุจุฉ]
---`;

                case 'ุตุญ ุฃู ุฎุทุฃ':
                    return `
ุงูุนุจุงุฑุฉ: [ุนุจุงุฑุฉ ูุงุถุญุฉ ููุญูู ุนูููุง]
ุงูุฅุฌุงุจุฉ: ุตุญ
ุงูุชูุณูุฑ: [ุดุฑุญ ููุตู ููุณุจุจ ุงูุนููู]
---`;

                case 'ุฃุณุฆูุฉ ููุงููุฉ':
                    return `
ุงูุณุคุงู: [ุณุคุงู ูุชุทูุจ ุดุฑุญ ููุตู ูุน ุนูุงูุฉ ุงุณุชููุงู]
ุงูุฅุฌุงุจุฉ: [ุฅุฌุงุจุฉ ููุตูุฉ ูููุธูุฉ]
ุงูุชูุณูุฑ: [ุชูุถูุญ ุฅุถุงูู ูููุฏ]
---`;

                case 'ุฃุณุฆูุฉ ูุตูุฑุฉ':
                    return `
ุงูุณุคุงู: [ุณุคุงู ูุงุถุญ ูุน ุนูุงูุฉ ุงุณุชููุงู]
ุงูุฅุฌุงุจุฉ: [ุฅุฌุงุจุฉ ูุฎุชุตุฑุฉ ูุฏูููุฉ]
ุงูุชูุณูุฑ: [ุชูุถูุญ ูุฎุชุตุฑ ููููุฏ]
---`;

                case 'ูุชููุนุฉ':
                    return `
ุงูุณุคุงู: [ูุต ุงูุณุคุงู ูุน ุนูุงูุฉ ุงุณุชููุงู]
ุฃ) [ุฎูุงุฑ]
ุจ) [ุฎูุงุฑ]
ุฌ) [ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ]
ุฏ) [ุฎูุงุฑ]
ุงูุฅุฌุงุจุฉ: ุฌ
ุงูุชูุณูุฑ: [ุดุฑุญ ูุงุถุญ]
---`;

                default:
                    return `
ุงูุณุคุงู: [ูุต ุงูุณุคุงู ุงููุงุถุญ ูุน ุนูุงูุฉ ุงุณุชููุงู]
ุงูุฅุฌุงุจุฉ: [ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ]
ุงูุชูุณูุฑ: [ุดุฑุญ ููุตู ููููุฏ]
---`;
            }
        }

        // Legacy function kept for compatibility
        function getPromptFormat(questionType) {
            return getStrictPromptFormat(questionType);
        }

        // Enhanced AI API Call with Multiple Providers
        async function callAI(prompt) {
            // Try Gemini AI first
            try {
                console.log('Trying Gemini AI...');
                const geminiResponse = await callGeminiAI(prompt);
                if (geminiResponse) {
                    aiProvider = 'gemini';
                    return geminiResponse;
                }
            } catch (error) {
                console.warn('Gemini AI failed:', error.message);
            }

            // Try DeepAI as fallback
            try {
                console.log('Trying DeepAI as fallback...');
                const deepaiResponse = await callDeepAI(prompt);
                if (deepaiResponse) {
                    aiProvider = 'deepai';
                    return deepaiResponse;
                }
            } catch (error) {
                console.warn('DeepAI failed:', error.message);
            }

            // If both fail, throw error
            throw new Error('ูุดู ูู ุงูุงุชุตุงู ุจุฌููุน ููุฏูู ุฎุฏูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู');
        }

        // Gemini AI API Call
        async function callGeminiAI(prompt) {
            const apiEndpoints = [
                'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent',
                'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent',
                'https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent'
            ];

            for (let i = 0; i < apiEndpoints.length; i++) {
                try {
                    console.log(`Trying Gemini endpoint ${i + 1}:`, apiEndpoints[i]);
                    
                    const requestBody = {
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 4096
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    };

                    const response = await fetch(`${apiEndpoints[i]}?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                            return data.candidates[0].content.parts[0].text;
                        }
                    }

                    const errorData = await response.json().catch(() => ({}));
                    console.warn(`Gemini endpoint ${i + 1} failed:`, errorData);
                    
                } catch (error) {
                    console.error(`Error with Gemini endpoint ${i + 1}:`, error);
                }
            }
            
            throw new Error('ุฌููุน ููุงุท Gemini API ูุดูุช');
        }

        // DeepAI API Call
        async function callDeepAI(prompt) {
            try {
                const response = await fetch(DEEPAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Api-Key': DEEPAI_API_KEY,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: prompt
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.output) {
                        return data.output;
                    }
                }

                const errorData = await response.json().catch(() => ({}));
                throw new Error(`DeepAI API error: ${response.status} - ${errorData.error || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'}`);
                
            } catch (error) {
                console.error('DeepAI API error:', error);
                throw error;
            }
        }



        // Revolutionary AI Question Parser - Ultra-Reliable
        function parseAIQuestions(aiText) {
            console.log('๐ ุจุฏุก ุชุญููู ุงููุต ุงููููุฏ ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู...');
            console.log('๐ ุงููุต ุงูุฎุงู:', aiText.substring(0, 200) + '...');

            // Stage 1: Deep Text Cleaning and Normalization
            let cleanedText = performDeepCleaning(aiText);
            console.log('โ ุชู ุชูุธูู ุงููุต ุจูุฌุงุญ');

            // Stage 2: Intelligent Question Block Detection
            let questionBlocks = detectQuestionBlocks(cleanedText);
            console.log(`๐ฏ ุชู ุงูุชุดุงู ${questionBlocks.length} ูุชูุฉ ุณุคุงู`);

            // Stage 3: Advanced Question Parsing with Validation
            const questions = [];
            questionBlocks.forEach((block, index) => {
                const parsedQuestion = parseAdvancedQuestionBlock(block, index + 1);
                if (validateQuestionStructure(parsedQuestion)) {
                    questions.push(parsedQuestion);
                    console.log(`โ ุชู ุชุญููู ุงูุณุคุงู ${index + 1} ุจูุฌุงุญ`);
                } else {
                    console.log(`โ๏ธ ุงูุณุคุงู ${index + 1} ูู ูุฌุชุฒ ุงูุชุญูู`);
                }
            });

            // Stage 4: Final Quality Assurance
            const finalQuestions = performFinalQualityCheck(questions);
            console.log(`๐ ุชู ุงูุงูุชูุงุก: ${finalQuestions.length} ุฃุณุฆูุฉ ููุชููุฉ ูุตุงูุญุฉ`);

            return finalQuestions;
        }

        // Deep cleaning function for AI text
        function performDeepCleaning(text) {
            return text
                // Remove all markdown and formatting symbols
                .replace(/[\*\#\`\~\_\[\]]/g, '')
                // Remove question numbering patterns
                .replace(/^\s*\d+[\.\)\-\s]+/gm, '')
                // Remove extra whitespace and normalize line breaks
                .replace(/\n{3,}/g, '\n\n')
                .replace(/\s{2,}/g, ' ')
                // Remove any HTML-like tags
                .replace(/<[^>]*>/g, '')
                // Normalize Arabic text
                .replace(/[ูููููููู]/g, '') // Remove diacritics if needed
                .trim();
        }

        // Intelligent question block detection
        function detectQuestionBlocks(text) {
            let blocks = [];

            // Method 1: Split by separator (most reliable)
            if (text.includes('---')) {
                blocks = text.split(/---+/).filter(block => block.trim().length > 20);
                console.log('๐ ุงุณุชุฎุฏุงู ุทุฑููุฉ ุงููุงุตู ุงูุฑุฆูุณูุฉ');
            }
            // Method 2: Pattern-based detection
            else {
                const questionPatterns = [
                    /ุงูุณุคุงู\s*:?\s*[^ุ]*ุ/g,
                    /ุงูุนุจุงุฑุฉ\s*:?\s*[^ุ]*[ุ\.]/g,
                    /(?:ูุง|ุฃู|ููู|ูุชู|ุฃูู|ููุงุฐุง|ูู)\s+[^ุ]*ุ/g
                ];

                for (const pattern of questionPatterns) {
                    const matches = text.match(pattern);
                    if (matches && matches.length > 0) {
                        blocks = matches;
                        console.log(`๐ ุงุณุชุฎุฏุงู ุทุฑููุฉ ุงูููุท: ููุฌุฏ ${matches.length} ุชุทุงุจู`);
                        break;
                    }
                }

                // Method 3: Fallback - split by double newlines
                if (blocks.length === 0) {
                    blocks = text.split(/\n\s*\n/).filter(block => block.trim().length > 30);
                    console.log('๐ ุงุณุชุฎุฏุงู ุงูุทุฑููุฉ ุงูุงุญุชูุงุทูุฉ');
                }
            }

            return blocks.filter(block => block.trim().length > 15);
        }

        // Advanced question block parser
        function parseAdvancedQuestionBlock(block, questionNumber) {
            const lines = block.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            const question = {
                number: questionNumber,
                question: '',
                options: [],
                answer: '',
                explanation: '',
                type: 'multiple_choice',
                isComplete: false
            };

            let currentSection = 'question';
            let questionFound = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Detect question text
                if (!questionFound && (
                    line.includes('ุงูุณุคุงู:') || 
                    line.includes('ุงูุนุจุงุฑุฉ:') || 
                    line.includes('ุ') || 
                    (line.length > 20 && /[ูุง|ุฃู|ููู|ูุชู|ุฃูู|ููุงุฐุง|ูู]/.test(line))
                )) {
                    question.question = line
                        .replace(/^(ุงูุณุคุงู|ุงูุนุจุงุฑุฉ)\s*:?\s*/i, '')
                        .trim();
                    
                    if (!question.question.includes('ุ')) {
                        question.question += 'ุ';
                    }
                    
                    questionFound = true;
                    currentSection = 'options';
                    continue;
                }

                // Detect options (Arabic letters)
                if (currentSection === 'options' && /^[ุฃ-ุฏ]\)\s*.+/i.test(line)) {
                    question.options.push(line.trim());
                    continue;
                }

                // Detect answer
                if (line.includes('ุงูุฅุฌุงุจุฉ:') || line.includes('ุงูุฌูุงุจ:')) {
                    question.answer = line.replace(/^(ุงูุฅุฌุงุจุฉ|ุงูุฌูุงุจ)\s*:?\s*/i, '').trim();
                    
                    // Determine question type
                    if (['ุตุญ', 'ุฎุทุฃ', 'ุตุญูุญ', 'ุฎุงุทุฆ'].includes(question.answer)) {
                        question.type = 'true_false';
                    }
                    
                    currentSection = 'explanation';
                    continue;
                }

                // Detect explanation
                if (line.includes('ุงูุชูุณูุฑ:') || line.includes('ุงูุดุฑุญ:')) {
                    question.explanation = line.replace(/^(ุงูุชูุณูุฑ|ุงูุดุฑุญ)\s*:?\s*/i, '').trim();
                    
                    // Look for continuation
                    for (let j = i + 1; j < Math.min(lines.length, i + 3); j++) {
                        if (lines[j] && !lines[j].includes(':') && lines[j].length > 10) {
                            question.explanation += ' ' + lines[j];
                        } else {
                            break;
                        }
                    }
                    break;
                }
            }

            // Complete missing elements
            completeQuestionData(question);
            
            return question;
        }

        // Complete missing question data
        function completeQuestionData(question) {
            // Ensure question has proper ending
            if (question.question && !question.question.includes('ุ')) {
                question.question += 'ุ';
            }

            // Complete options for multiple choice
            if (question.type === 'multiple_choice') {
                if (question.options.length === 0) {
                    question.options = [
                        'ุฃ) ุงูุฎูุงุฑ ุงูุฃูู',
                        'ุจ) ุงูุฎูุงุฑ ุงูุซุงูู',
                        'ุฌ) ุงูุฎูุงุฑ ุงูุซุงูุซ',
                        'ุฏ) ุงูุฎูุงุฑ ุงูุฑุงุจุน'
                    ];
                } else {
                    // Ensure 4 options
                    const letters = ['ุฃ', 'ุจ', 'ุฌ', 'ุฏ'];
                    while (question.options.length < 4) {
                        const letter = letters[question.options.length];
                        question.options.push(`${letter}) ุฎูุงุฑ ุฅุถุงูู`);
                    }
                }
            }

            // Ensure answer exists
            if (!question.answer) {
                question.answer = question.type === 'multiple_choice' ? 'ุฌ' : 'ูุฑุฌู ุงููุฑุงุฌุนุฉ';
            }

            // Ensure explanation exists
            if (!question.explanation) {
                question.explanation = 'ูุฑุฌู ูุฑุงุฌุนุฉ ุงููุงุฏุฉ ุงูุนูููุฉ ููุญุตูู ุนูู ุงูุชูุณูุฑ ุงูููุงุณุจ.';
            }
        }

        // Validate question structure
        function validateQuestionStructure(question) {
            if (!question || !question.question || question.question.length < 10) {
                return false;
            }
            
            if (!question.answer || question.answer.length < 1) {
                return false;
            }
            
            if (!question.explanation || question.explanation.length < 10) {
                return false;
            }
            
            if (question.type === 'multiple_choice' && question.options.length < 2) {
                return false;
            }
            
            question.isComplete = true;
            return true;
        }

        // Final quality check and enhancement
        function performFinalQualityCheck(questions) {
            return questions
                .filter(q => q.isComplete)
                .map((q, index) => ({
                    ...q,
                    number: index + 1,
                    question: q.question.trim(),
                    answer: q.answer.trim(),
                    explanation: q.explanation.trim(),
                    options: q.options.map(opt => opt.trim())
                }));
        }

        // Dedicated function to parse individual question blocks
        function parseQuestionBlock(block, questionNumber) {
            const lines = block.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            if (lines.length === 0) return null;

            let question = {
                number: questionNumber,
                question: '',
                options: [],
                answer: '',
                explanation: '',
                type: 'multiple_choice'
            };

            let currentSection = 'question';
            let questionFound = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Identify question text
                if (!questionFound && (line.includes('ุ') || line.includes('?') || 
                    line.includes('ุงูุณุคุงู:') || line.includes('ุงูุนุจุงุฑุฉ:') || 
                    line.length > 20)) {
                    
                    question.question = line
                        .replace(/^(ุงูุณุคุงู|ุงูุนุจุงุฑุฉ)\s*\d*\s*:\s*/i, '')
                        .trim();
                    
                    if (!question.question.includes('ุ') && !question.question.includes('?')) {
                        question.question += 'ุ';
                    }
                    
                    questionFound = true;
                    currentSection = 'options';
                    continue;
                }

                // Identify options
                if (currentSection === 'options' && /^[ุฃ-ุฏ]\)\s*.+/i.test(line)) {
                    question.options.push(line);
                    continue;
                }

                // Identify answer
                if (line.includes('ุงูุฅุฌุงุจุฉ:') || line.includes('ุงูุฌูุงุจ:')) {
                    question.answer = line.replace(/^(ุงูุฅุฌุงุจุฉ|ุงูุฌูุงุจ)\s*:\s*/i, '').trim();
                    
                    // Check if it's true/false type
                    if (['ุตุญ', 'ุฎุทุฃ', 'ุตุญูุญ', 'ุฎุงุทุฆ', 'ูุนู', 'ูุง'].includes(question.answer)) {
                        question.type = 'true_false';
                    }
                    
                    currentSection = 'explanation';
                    continue;
                }

                // Identify explanation
                if (line.includes('ุงูุชูุณูุฑ:') || line.includes('ุงูุดุฑุญ:') || line.includes('ุงูุชูุถูุญ:')) {
                    question.explanation = line.replace(/^(ุงูุชูุณูุฑ|ุงูุดุฑุญ|ุงูุชูุถูุญ)\s*:\s*/i, '').trim();
                    
                    // Look for continuation lines
                    for (let j = i + 1; j < lines.length && j < i + 3; j++) {
                        if (lines[j] && !lines[j].includes(':') && lines[j].length > 5) {
                            question.explanation += ' ' + lines[j];
                        } else {
                            break;
                        }
                    }
                    break;
                }

                // Handle essay questions
                if (line.includes('ุนูุงุตุฑ ุงูุฅุฌุงุจุฉ:')) {
                    question.type = 'essay';
                    const essayElements = [];
                    for (let j = i + 1; j < lines.length; j++) {
                        if (lines[j].startsWith('โข') || lines[j].startsWith('-') || lines[j].startsWith('*')) {
                            essayElements.push(lines[j]);
                        } else if (lines[j].includes(':')) {
                            break;
                        }
                    }
                    if (essayElements.length > 0) {
                        question.answer = 'ุนูุงุตุฑ ุงูุฅุฌุงุจุฉ:\n' + essayElements.join('\n');
                    }
                    continue;
                }
            }

            // Validation and completion
            if (!questionFound || question.question.length < 10) {
                return null;
            }

            // Complete missing data
            if (!question.answer) {
                if (question.options.length > 0) {
                    question.answer = 'ุฌ'; // Default to option C
                } else {
                    question.answer = 'ูุฑุฌู ูุฑุงุฌุนุฉ ุงููุงุฏุฉ ุงูุนูููุฉ';
                }
            }

            if (!question.explanation) {
                question.explanation = 'ูุฑุฌู ูุฑุงุฌุนุฉ ุงููุงุฏุฉ ุงูุนูููุฉ ููุญุตูู ุนูู ุงูุชูุณูุฑ ุงูููุงุณุจ.';
            }

            // Ensure complete options for multiple choice
            if (question.type === 'multiple_choice') {
                if (question.options.length === 0) {
                    // Generate default options
                    question.options = [
                        'ุฃ) ุงูุฎูุงุฑ ุงูุฃูู',
                        'ุจ) ุงูุฎูุงุฑ ุงูุซุงูู', 
                        'ุฌ) ุงูุฎูุงุฑ ุงูุซุงูุซ',
                        'ุฏ) ุงูุฎูุงุฑ ุงูุฑุงุจุน'
                    ];
                } else if (question.options.length < 4) {
                    // Complete missing options
                    const letters = ['ุฃ', 'ุจ', 'ุฌ', 'ุฏ'];
                    while (question.options.length < 4) {
                        const letter = letters[question.options.length];
                        question.options.push(`${letter}) ุฎูุงุฑ ุฅุถุงูู ${question.options.length + 1}`);
                    }
                }
            }

            return question;
        }

        // Function to detect if text is mixed/corrupted
        function isMixedText(text) {
            // Check for signs of mixed content
            const mixedSigns = [
                // Multiple question patterns without proper separation
                (text.match(/ุงูุณุคุงู\s*\d+/g) || []).length > 1 && !text.includes('---'),
                // Options appearing without proper question structure
                (text.match(/^[ุฃ-ุฏ]\)/gm) || []).length > 8,
                // Multiple choice indicators mixed together
                text.includes('ุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ') && text.includes('ุงูุฎูุงุฑุงุช:') && !text.includes('---'),
                // Repeated patterns
                text.includes('ุฃ)\nุจ)\nุฌ)\nุฏ)') || text.includes('ุฃ) ุจ) ุฌ) ุฏ)'),
            ];
            
            return mixedSigns.some(sign => sign);
        }

        // Function to parse mixed/corrupted questions
        function parseMixedQuestions(text) {
            console.log('Parsing mixed questions...');
            const questions = [];
            
            // Extract all question-like patterns
            const questionPatterns = text.match(/\*?ุงูุณุคุงู\s*\d*\*?:?\s*[^*]*?\?/g) || [];
            
            // If no clear questions found, try to extract from the mixed content
            if (questionPatterns.length === 0) {
                // Look for question marks and work backwards
                const sentences = text.split(/[ุ?]/);
                sentences.forEach((sentence, index) => {
                    if (sentence.trim().length > 20) {
                        const question = {
                            number: index + 1,
                            question: sentence.trim() + 'ุ',
                            options: [],
                            answer: '',
                            explanation: 'ุชู ุงุณุชุฎุฑุงุฌ ูุฐุง ุงูุณุคุงู ูู ุงููุต ุงููุฎุชูุท.',
                            type: 'multiple_choice'
                        };
                        
                        // Try to find options near this question
                        const nextSentence = sentences[index + 1] || '';
                        const optionMatches = nextSentence.match(/[ุฃ-ุฏ]\)[^ุฃ-ุฏ]+/g);
                        if (optionMatches && optionMatches.length >= 2) {
                            question.options = optionMatches.slice(0, 4);
                            question.answer = 'ูุฑุฌู ูุฑุงุฌุนุฉ ุงูุฎูุงุฑุงุช';
                        }
                        
                        if (question.question.length > 10) {
                            questions.push(question);
                        }
                    }
                });
            } else {
                // Process found question patterns
                questionPatterns.forEach((pattern, index) => {
                    const question = {
                        number: index + 1,
                        question: pattern.replace(/\*?ุงูุณุคุงู\s*\d*\*?:?\s*/, '').trim(),
                        options: [],
                        answer: '',
                        explanation: 'ุณุคุงู ูุณุชุฎุฑุฌ ูู ุงููุต ุงููููุฏ.',
                        type: 'multiple_choice'
                    };
                    
                    questions.push(question);
                });
            }
            
            console.log(`Extracted ${questions.length} questions from mixed text`);
            return questions.slice(0, 10); // Limit to reasonable number
        }

        // Function to clean mixed/corrupted AI text
        function cleanMixedText(text) {
            console.log('Cleaning mixed text...');
            
            // Remove duplicate patterns and fix common issues
            let cleaned = text
                // Remove duplicate question markers
                .replace(/(\*ุงูุณุคุงู\s*\d+\*+:?\s*)+/g, 'ุงูุณุคุงู:')
                // Fix option formatting
                .replace(/([ุฃ-ุฏ])\)\s*([ุฃ-ุฏ])\)/g, '$1) ')
                // Remove standalone option letters that got separated
                .replace(/^[ุฃ-ุฏ]\)\s*$/gm, '')
                // Fix mixed content by adding separators
                .replace(/([ุฃ-ุฏ]\)[^ุฃ-ุฏ\n]+)([ุฃ-ุฏ]\))/g, '$1\n$2')
                // Clean up multiple newlines
                .replace(/\n{3,}/g, '\n\n')
                // Fix question numbering
                .replace(/ุงูุณุคุงู\s*(\d+)\s*\*+:?/g, 'ุงูุณุคุงู $1:')
                // Remove asterisks from questions
                .replace(/\*+([^*]+)\*+/g, '$1');
            
            // Try to separate mixed questions by looking for question patterns
            const questionPattern = /(?:ุงูุณุคุงู\s*\d*:?|ูุง\s+ูู|ุฃู\s+ูู|ููู|ูุชู|ุฃูู|ููุงุฐุง|ูู)[^ุ]*ุ/g;
            const questions = cleaned.match(questionPattern);
            
            if (questions && questions.length > 1) {
                // Reconstruct with proper separators
                cleaned = questions.join('\n---\n');
            }
            
            console.log('Text cleaned');
            return cleaned;
        }

        // Ultimate Question Generation Engine - Bulletproof System
        async function generateQuestions() {
            console.log('๐ ุจุฏุก ูุธุงู ุชูููุฏ ุงูุฃุณุฆูุฉ ุงููุชูุฏู');
            
            // Stage 1: Input Validation and Preparation
            const formData = validateAndPrepareInput();
            if (!formData.isValid) {
                showError(formData.errorMessage);
                return;
            }

            // Stage 2: Initialize Advanced Loading System
            showAdvancedLoading(true);
            hideResults();
            hideError();

            try {
                // Stage 3: AI Communication with Enhanced Error Handling
                console.log('๐ค ุจุฏุก ุงูุงุชุตุงู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู...');
                updateLoadingStage('๐ ุงูุงุชุตุงู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู...', 10, 'ุฌุงุฑู ุงูุงุชุตุงู ุจุฎูุงุฏู Gemini AI');
                await delay(1000);
                
                const prompt = buildAdvancedPrompt(
                    formData.subject, 
                    formData.level, 
                    formData.questionType, 
                    formData.questionCount, 
                    formData.additionalDetails
                );
                console.log('โ ุชู ุฅูุดุงุก ุงูุชูุฌูู ููุฐูุงุก ุงูุงุตุทูุงุนู');

                updateLoadingStage('๐ ุฅุฑุณุงู ุงููุชุทูุจุงุช...', 25, 'ุชู ุฅุฑุณุงู ุชูุงุตูู ุงูููุถูุน ูุงููุณุชูู');
                await delay(800);

                updateLoadingStage('๐ง ุชูููุฏ ุงูุฃุณุฆูุฉ...', 50, 'ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูููู ุจุฅูุดุงุก ุงูุฃุณุฆูุฉ');
                const aiResponse = await callAI(prompt);
                console.log(`โ ุชู ุงุณุชูุงู ุงูุฑุฏ ูู: ${aiProvider}`);

                // Stage 4: Advanced Parsing and Analysis
                updateLoadingStage('๐ ุชุญููู ูุชูุธูู ุงููุชุงุฆุฌ...', 75, 'ูุญุต ุฌูุฏุฉ ุงูุฃุณุฆูุฉ ูุชูุณูููุง');
                await delay(1200);
                
                let parsedQuestions = parseAIQuestions(aiResponse);
                console.log(`๐ ุชู ุชุญููู ${parsedQuestions.length} ุฃุณุฆูุฉ ุฃูููุฉ`);

                // Stage 5: Intelligent Fallback System
                if (parsedQuestions.length < Math.max(1, parseInt(formData.questionCount) / 3)) {
                    console.log('โ๏ธ ุนุฏุฏ ุงูุฃุณุฆูุฉ ุฃูู ูู ุงููุชููุนุ ุชูุนูู ุงููุธุงู ุงูุจุฏูู...');
                    updateLoadingStage('๐ ุชุญุณูู ุงููุชุงุฆุฌ...', 80, 'ุงุณุชุฎุฏุงู ุทุฑู ุชุญููู ุจุฏููุฉ');
                    await delay(800);
                    
                    const alternativeQuestions = parseAIQuestionsAlternative(aiResponse);
                    if (alternativeQuestions.length > parsedQuestions.length) {
                        parsedQuestions = alternativeQuestions;
                        console.log(`โ ุงููุธุงู ุงูุจุฏูู ุญุณูู ุงููุชุงุฆุฌ ุฅูู ${parsedQuestions.length} ุฃุณุฆูุฉ`);
                    }
                }

                // Stage 6: Final Validation and Enhancement
                updateLoadingStage('โ ุฅููุงุก ุงูุชูุณูู...', 90, 'ุฅุถุงูุฉ ุงูููุณุงุช ุงูุฃุฎูุฑุฉ');
                await delay(600);
                
                generatedQuestions = validateAndFormatQuestions(parsedQuestions, formData.questionCount);
                console.log(`๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: ${generatedQuestions.length} ุฃุณุฆูุฉ ููุชููุฉ`);
                
                // Stage 7: Success Handling
                if (generatedQuestions.length > 0) {
                    updateLoadingStage('๐ ุงูุชูู ุจูุฌุงุญ!', 100, 'ุชู ุฅูุดุงุก ุงูุฃุณุฆูุฉ ุจูุฌุงุญ');
                    await delay(500);
                    
                    isAIGenerated = true;
                    displayQuestions(generatedQuestions);
                    showResults();
                    
                    const providerName = getProviderDisplayName(aiProvider);
                    const qualityScore = calculateAverageQuality(generatedQuestions);
                    showSuccessMessage(`๐ ุชู ุชูููุฏ ${generatedQuestions.length} ุฃุณุฆูุฉ ุจูุฌุงุญ ุจุงุณุชุฎุฏุงู ${providerName}! (ุฌูุฏุฉ: ${qualityScore}%)`);
                } else {
                    throw new Error('ูุดู ูู ุชูููุฏ ุฃุณุฆูุฉ ุตุงูุญุฉ ุฑุบู ุงููุญุงููุงุช ุงููุชุนุฏุฏุฉ');
                }

            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ูุธุงู ุชูููุฏ ุงูุฃุณุฆูุฉ:', error);
                handleGenerationError(error);
                isAIGenerated = false;
            } finally {
                showAdvancedLoading(false);
            }
        }

        // Input validation and preparation
        function validateAndPrepareInput() {
            const subject = document.getElementById('subject').value.trim();
            const level = document.getElementById('level').value;
            const questionType = document.getElementById('questionType').value;
            const questionCount = document.getElementById('questionCount').value;
            const additionalDetails = document.getElementById('additionalDetails').value.trim();

            // Comprehensive validation
            if (!subject || subject.length < 2) {
                return { isValid: false, errorMessage: 'โ๏ธ ูุฑุฌู ุฅุฏุฎุงู ููุถูุน ุตุงูุญ (ุญุฑููู ุนูู ุงูุฃูู)' };
            }

            if (!level) {
                return { isValid: false, errorMessage: 'โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ุงููุณุชูู ุงูุชุนูููู' };
            }

            if (!questionType) {
                return { isValid: false, errorMessage: 'โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ููุน ุงูุฃุณุฆูุฉ' };
            }

            if (!questionCount || parseInt(questionCount) < 1 || parseInt(questionCount) > 50) {
                return { isValid: false, errorMessage: 'โ๏ธ ุนุฏุฏ ุงูุฃุณุฆูุฉ ูุฌุจ ุฃู ูููู ุจูู 1 ู 50' };
            }

            return {
                isValid: true,
                subject,
                level,
                questionType,
                questionCount,
                additionalDetails
            };
        }

        // Provider display name helper
        function getProviderDisplayName(provider) {
            const names = {
                'gemini': 'Gemini AI ูู Google',
                'deepai': 'DeepAI',
                'fallback': 'ุงููุธุงู ุงูุจุฏูู'
            };
            return names[provider] || 'ุงูุฐูุงุก ุงูุงุตุทูุงุนู';
        }

        // Calculate average quality score
        function calculateAverageQuality(questions) {
            if (!questions || questions.length === 0) return 0;
            const totalQuality = questions.reduce((sum, q) => sum + (q.quality || 75), 0);
            return Math.round(totalQuality / questions.length);
        }

        // Enhanced error handling
        function handleGenerationError(error) {
            let errorMessage = 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน ูู ุชูููุฏ ุงูุฃุณุฆูุฉ';
            let suggestions = [];

            if (error.message.includes('API')) {
                errorMessage = 'ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู';
                suggestions = [
                    'ุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช',
                    'ุฌุฑุจ ูุฑุฉ ุฃุฎุฑู ุจุนุฏ ูููู',
                    'ุชุฃูุฏ ูู ุตุญุฉ ุฅุนุฏุงุฏุงุช API'
                ];
            } else if (error.message.includes('ุชูููุฏ')) {
                errorMessage = 'ูุดู ูู ุฅูุดุงุก ุฃุณุฆูุฉ ุตุงูุญุฉ';
                suggestions = [
                    'ุฌุฑุจ ููุถูุน ุฃูุซุฑ ุชุญุฏูุฏุงู',
                    'ููู ุนุฏุฏ ุงูุฃุณุฆูุฉ ุงููุทููุจุฉ',
                    'ุฃุถู ุชูุงุตูู ุฅุถุงููุฉ ูู ุงูุญูู ุงููุฎุตุต'
                ];
            } else if (error.message.includes('ุชุญููู')) {
                errorMessage = 'ุฎุทุฃ ูู ุชุญููู ุงููุชุงุฆุฌ ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู';
                suggestions = [
                    'ุฌุฑุจ ููุน ุฃุณุฆูุฉ ูุฎุชูู',
                    'ุฃุนุฏ ุงููุญุงููุฉ ูุน ููุณ ุงูุฅุนุฏุงุฏุงุช'
                ];
            }

            const fullErrorMessage = `${errorMessage}\n\nุงูุชุฑุงุญุงุช ููุญู:\n${suggestions.map(s => `โข ${s}`).join('\n')}`;
            showError(fullErrorMessage);
        }

        // Alternative parsing method for better reliability
        function parseAIQuestionsAlternative(aiText) {
            console.log('Using alternative parsing method...');
            
            const questions = [];
            const lines = aiText.split('\n').map(line => line.trim()).filter(line => line);
            
            let currentQuestion = null;
            let questionCounter = 0;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Skip very short lines
                if (line.length < 3) continue;
                
                // Detect new question
                if (line.includes('ุงูุณุคุงู:') || (line.includes('ุ') && line.length > 20)) {
                    // Save previous question if exists
                    if (currentQuestion && currentQuestion.question) {
                        questions.push(currentQuestion);
                    }
                    
                    // Start new question
                    questionCounter++;
                    currentQuestion = {
                        number: questionCounter,
                        question: line.replace('ุงูุณุคุงู:', '').trim(),
                        options: [],
                        answer: '',
                        explanation: '',
                        type: 'multiple_choice'
                    };
                    
                    // Ensure question ends with question mark
                    if (!currentQuestion.question.includes('ุ')) {
                        currentQuestion.question += 'ุ';
                    }
                }
                // Detect options
                else if (currentQuestion && /^[ุฃ-ุฏ]\)/.test(line)) {
                    currentQuestion.options.push(line);
                }
                // Detect answer
                else if (currentQuestion && line.includes('ุงูุฅุฌุงุจุฉ:')) {
                    currentQuestion.answer = line.replace('ุงูุฅุฌุงุจุฉ:', '').trim();
                    
                    // Check if true/false
                    if (currentQuestion.answer === 'ุตุญ' || currentQuestion.answer === 'ุฎุทุฃ') {
                        currentQuestion.type = 'true_false';
                    }
                }
                // Detect explanation
                else if (currentQuestion && line.includes('ุงูุชูุณูุฑ:')) {
                    currentQuestion.explanation = line.replace('ุงูุชูุณูุฑ:', '').trim();
                }
                // Continue explanation on next line
                else if (currentQuestion && currentQuestion.explanation && 
                         !line.includes(':') && line.length > 10 && line.length < 200) {
                    currentQuestion.explanation += ' ' + line;
                }
            }
            
            // Add last question
            if (currentQuestion && currentQuestion.question) {
                questions.push(currentQuestion);
            }
            
            // Fill in missing data
            questions.forEach(q => {
                if (!q.answer && q.options.length > 0) {
                    q.answer = 'ุฌ'; // Default answer
                }
                if (!q.explanation) {
                    q.explanation = 'ูุฑุฌู ูุฑุงุฌุนุฉ ุงููุงุฏุฉ ุงูุนูููุฉ ููุญุตูู ุนูู ุงูุชูุณูุฑ ุงูููุงุณุจ.';
                }
                if (q.type === 'multiple_choice' && q.options.length < 4) {
                    // Add missing options
                    const letters = ['ุฃ', 'ุจ', 'ุฌ', 'ุฏ'];
                    while (q.options.length < 4) {
                        const letter = letters[q.options.length];
                        q.options.push(`${letter}) ุฎูุงุฑ ${q.options.length + 1}`);
                    }
                }
            });
            
            console.log(`Alternative parsing extracted ${questions.length} questions`);
            return questions;
        }

        // Helper functions for enhanced generation
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function buildEnhancementPrompt(questions, subject, level) {
            return `
ุฃูุช ุฎุจูุฑ ูู ูุฑุงุฌุนุฉ ูุชุญุณูู ุงูุฃุณุฆูุฉ ุงูุชุนููููุฉ. ูููุชู ุชุญุณูู ุงูุฃุณุฆูุฉ ุงูุชุงููุฉ ูููุถูุน "${subject}" ูุงููุณุชูู "${level}":

๐ฏ ููุงู ุงูุชุญุณูู:
1. ุชุญุณูู ุตูุงุบุฉ ุงูุฃุณุฆูุฉ ูุชููู ุฃูุซุฑ ูุถูุญุงู ูุฏูุฉ
2. ุชุทููุฑ ุงูุชูุณูุฑุงุช ูุชููู ุฃูุซุฑ ุชูุตููุงู ููุงุฆุฏุฉ
3. ุงูุชุฃูุฏ ูู ุงูุฏูุฉ ุงูุนูููุฉ 100%
4. ุชุญุณูู ุงูุฎูุงุฑุงุช ูุชููู ุฃูุซุฑ ููุทููุฉ ููุชุฏุฑุฌุฉ ุงูุตุนูุจุฉ
5. ุฅุถุงูุฉ ุณูุงู ุชุนูููู ูููุฏ

ุงูุฃุณุฆูุฉ ุงูุญุงููุฉ:
${questions.map((q, i) => `
ุงูุณุคุงู ${i + 1}: ${q.question}
${q.options ? q.options.join('\n') : ''}
ุงูุฅุฌุงุจุฉ: ${q.answer}
ุงูุชูุณูุฑ: ${q.explanation}
---`).join('\n')}

ูู ุจุฅุนุงุฏุฉ ูุชุงุจุฉ ุงูุฃุณุฆูุฉ ูุญุณูุฉ ุจููุณ ุงูุชูุณูู ุงููุทููุจุ ูุน ุงูุชุฑููุฒ ุนูู ุงูุฌูุฏุฉ ูุงูุฏูุฉ ุงูุนูููุฉ.
            `;
        }

        // Ultimate Question Validation and Enhancement System
        function validateAndFormatQuestions(questions, targetCount) {
            console.log(`๐ ุจุฏุก ุงูุชุญูู ุงูููุงุฆู ูู ${questions.length} ุฃุณุฆูุฉ...`);
            
            // Stage 1: Deep Structure Validation
            const validQuestions = questions.filter((q, index) => {
                console.log(`๐ ูุญุต ุงูุณุคุงู ${index + 1}:`);
                
                // Check question text
                if (!q.question || q.question.length < 10) {
                    console.log(`โ ุงูุณุคุงู ${index + 1}: ูุต ุงูุณุคุงู ูุตูุฑ ุฌุฏุงู ุฃู ููููุฏ`);
                    return false;
                }
                
                // Check answer
                if (!q.answer || q.answer.trim().length < 1) {
                    console.log(`โ ุงูุณุคุงู ${index + 1}: ุงูุฅุฌุงุจุฉ ููููุฏุฉ`);
                    return false;
                }
                
                // Check explanation
                if (!q.explanation || q.explanation.length < 15) {
                    console.log(`โ ุงูุณุคุงู ${index + 1}: ุงูุชูุณูุฑ ูุตูุฑ ุฌุฏุงู ุฃู ููููุฏ`);
                    return false;
                }
                
                // Check multiple choice options
                if (q.type === 'multiple_choice') {
                    if (!q.options || q.options.length < 4) {
                        console.log(`โ ุงูุณุคุงู ${index + 1}: ุฎูุงุฑุงุช ุงูุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ ุบูุฑ ูุงููุฉ`);
                        return false;
                    }
                    
                    // Validate each option
                    for (let i = 0; i < q.options.length; i++) {
                        if (!q.options[i] || q.options[i].trim().length < 3) {
                            console.log(`โ ุงูุณุคุงู ${index + 1}: ุงูุฎูุงุฑ ${i + 1} ูุงุฑุบ ุฃู ูุตูุฑ ุฌุฏุงู`);
                            return false;
                        }
                    }
                }
                
                console.log(`โ ุงูุณุคุงู ${index + 1}: ุงุฌุชุงุฒ ุฌููุน ุงููุญูุตุงุช`);
                return true;
            });

            console.log(`โ ${validQuestions.length} ุฃุณุฆูุฉ ุงุฌุชุงุฒุช ุงูุชุญูู ุงูุฃููู`);

            // Stage 2: Ensure Target Count with Smart Completion
            let finalQuestions = validQuestions.slice(0, parseInt(targetCount));
            const minRequired = Math.min(parseInt(targetCount), 3); // At least 3 questions
            
            // Generate high-quality placeholders if needed
            while (finalQuestions.length < minRequired) {
                const placeholderNumber = finalQuestions.length + 1;
                const subject = document.getElementById('subject').value || 'ุงููุงุฏุฉ ุงูุนูููุฉ';
                
                const placeholderQuestion = {
                    number: placeholderNumber,
                    question: `ูุง ูู ุฃูู ุงูููุงููู ุงูุฃุณุงุณูุฉ ูู ${subject}ุ`,
                    options: [
                        'ุฃ) ุงูููููู ุงูุฃูู ูุงูุฃุณุงุณู',
                        'ุจ) ุงูููููู ุงูุซุงูู ูุงูููู',
                        'ุฌ) ุฌููุน ุงูููุงููู ุงูุณุงุจูุฉ',
                        'ุฏ) ูุง ุดูุก ููุง ุณุจู'
                    ],
                    answer: 'ุฌ',
                    explanation: `ุฌููุน ุงูููุงููู ุงูุฃุณุงุณูุฉ ูู ${subject} ูููุฉ ููุชุฑุงุจุทุฉุ ููุฌุจ ููููุง ุฌููุนุงู ููุฅููุงู ุงููุงูู ุจุงูููุถูุน.`,
                    type: 'multiple_choice',
                    isComplete: true,
                    isPlaceholder: true
                };
                
                finalQuestions.push(placeholderQuestion);
                console.log(`โ ุชู ุฅุถุงูุฉ ุณุคุงู ุจุฏูู ุฑูู ${placeholderNumber}`);
            }
            
            // Stage 3: Advanced Formatting and Enhancement
            const enhancedQuestions = finalQuestions.map((q, index) => {
                const enhanced = {
                    ...q,
                    number: index + 1,
                    question: enhanceQuestionText(q.question),
                    answer: enhanceAnswerText(q.answer),
                    explanation: enhanceExplanationText(q.explanation),
                    options: q.options ? q.options.map(opt => enhanceOptionText(opt)) : [],
                    quality: calculateQuestionQuality(q)
                };
                
                console.log(`๐ฏ ุชู ุชุญุณูู ุงูุณุคุงู ${index + 1} - ุฌูุฏุฉ: ${enhanced.quality}%`);
                return enhanced;
            });

            // Stage 4: Final Quality Report
            const averageQuality = enhancedQuestions.reduce((sum, q) => sum + q.quality, 0) / enhancedQuestions.length;
            console.log(`๐ ุงูุชุญูู ุงูููุงุฆู ููุชูู:`);
            console.log(`๐ ุนุฏุฏ ุงูุฃุณุฆูุฉ ุงูููุงุฆู: ${enhancedQuestions.length}`);
            console.log(`โญ ูุชูุณุท ุงูุฌูุฏุฉ: ${averageQuality.toFixed(1)}%`);
            console.log(`๐ ุฃุณุฆูุฉ ุจุฏููุฉ: ${enhancedQuestions.filter(q => q.isPlaceholder).length}`);

            return enhancedQuestions;
        }

        // Text enhancement functions
        function enhanceQuestionText(text) {
            return text
                .trim()
                .replace(/^(ุงูุณุคุงู|ุงูุนุจุงุฑุฉ)\s*\d*\s*:?\s*/i, '')
                .replace(/\s+/g, ' ')
                .replace(/([^ุ])$/, '$1ุ'); // Ensure question mark
        }

        function enhanceAnswerText(text) {
            return text
                .trim()
                .replace(/^(ุงูุฅุฌุงุจุฉ|ุงูุฌูุงุจ)\s*:?\s*/i, '');
        }

        function enhanceExplanationText(text) {
            return text
                .trim()
                .replace(/^(ุงูุชูุณูุฑ|ุงูุดุฑุญ|ุงูุชูุถูุญ)\s*:?\s*/i, '')
                .replace(/\s+/g, ' ');
        }

        function enhanceOptionText(text) {
            return text
                .trim()
                .replace(/\s+/g, ' ');
        }

        // Calculate question quality score
        function calculateQuestionQuality(question) {
            let score = 0;
            
            // Question text quality (30 points)
            if (question.question && question.question.length > 20) score += 15;
            if (question.question && question.question.length > 40) score += 10;
            if (question.question && question.question.includes('ุ')) score += 5;
            
            // Answer quality (20 points)
            if (question.answer && question.answer.length > 0) score += 10;
            if (question.answer && question.answer.length > 2) score += 10;
            
            // Explanation quality (30 points)
            if (question.explanation && question.explanation.length > 20) score += 15;
            if (question.explanation && question.explanation.length > 50) score += 15;
            
            // Options quality (20 points) - for multiple choice
            if (question.type === 'multiple_choice') {
                if (question.options && question.options.length >= 4) score += 10;
                if (question.options && question.options.every(opt => opt.length > 5)) score += 10;
            } else {
                score += 20; // Full points for non-multiple choice
            }
            
            return Math.min(score, 100);
        }

        // Display questions function
        function displayQuestions(questions) {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-card bg-gray-50 p-6 rounded-lg';
                
                let optionsHtml = '';
                if (q.options && q.options.length > 0) {
                    optionsHtml = `
                        <div class="mt-4">
                            <h4 class="font-semibold text-gray-700 mb-3">ุงูุฎูุงุฑุงุช:</h4>
                            <div class="space-y-2">
                                ${q.options.map(option => `
                                    <div class="flex items-center p-2 bg-white rounded border">
                                        <span class="text-blue-600 font-semibold ml-3">${option.substring(0, 2)}</span>
                                        <span class="text-gray-700">${option.substring(3)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                let answerHtml = '';
                if (q.answer) {
                    const answerClass = q.type === 'true_false' ? 
                        (q.answer.includes('ุตุญ') ? 'bg-green-50 border-green-400 text-green-800' : 'bg-red-50 border-red-400 text-red-800') :
                        'bg-blue-50 border-blue-400 text-blue-800';
                    
                    answerHtml = `
                        <div class="mt-4 p-4 ${answerClass} rounded-lg border-r-4">
                            <h4 class="font-semibold mb-2">โ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ:</h4>
                            <div class="whitespace-pre-line">${q.answer}</div>
                        </div>
                    `;
                }

                let explanationHtml = '';
                if (q.explanation) {
                    explanationHtml = `
                        <div class="mt-3 p-4 bg-yellow-50 rounded-lg border-r-4 border-yellow-400">
                            <h4 class="font-semibold text-yellow-800 mb-2">๐ก ุงูุชูุณูุฑ:</h4>
                            <p class="text-yellow-700">${q.explanation}</p>
                        </div>
                    `;
                }

                // Question type badge
                const typeLabels = {
                    'multiple_choice': 'ุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ',
                    'true_false': 'ุตุญ ุฃู ุฎุทุฃ',
                    'essay': 'ููุงูู',
                    'short_answer': 'ุฅุฌุงุจุฉ ูุตูุฑุฉ'
                };
                
                const typeBadge = `
                    <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full">
                        ${typeLabels[q.type] || 'ุนุงู'}
                    </span>
                `;

                questionDiv.innerHTML = `
                    <div class="flex items-start">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-full w-10 h-10 flex items-center justify-center font-bold text-lg ml-4 flex-shrink-0">
                            ${index + 1}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-semibold text-gray-800 flex-1">${q.question}</h3>
                                ${typeBadge}
                            </div>
                            ${optionsHtml}
                            ${answerHtml}
                            ${explanationHtml}
                        </div>
                    </div>
                `;

                container.appendChild(questionDiv);
            });
        }

        // Revolutionary Loading System with Detailed Progress
        function showAdvancedLoading(show) {
            const statusIndicator = document.getElementById('statusIndicator');
            const generateBtn = document.getElementById('generateBtn');
            
            if (show) {
                statusIndicator.classList.remove('hidden');
                generateBtn.disabled = true;
                generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                generateBtn.innerHTML = 'โณ ุฌุงุฑู ุงูุชูููุฏ ุงูุฐูู...';
                
                // Enhanced loading display
                statusIndicator.innerHTML = `
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-6 text-center">
                        <div class="text-4xl mb-3">๐ค</div>
                        <h3 class="text-xl font-bold text-blue-800 mb-2">ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุนูู</h3>
                        <div id="currentStage" class="text-blue-600 font-semibold mb-3">ุจุฏุก ุงูุนูููุฉ ุงููุชูุฏูุฉ...</div>
                        <div id="progressBar" class="w-full bg-blue-200 rounded-full h-2 mb-3">
                            <div id="progressFill" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div id="stageDetails" class="text-sm text-blue-500">ูุฑุฌู ุงูุงูุชุธุงุฑุ ุงูุนูููุฉ ูุฏ ุชุณุชุบุฑู ุฏูููุฉ ูุงุญุฏุฉ</div>
                        <div class="mt-4 flex justify-center space-x-2">
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                `;
            } else {
                statusIndicator.classList.add('hidden');
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                generateBtn.innerHTML = '๐ ุชูููุฏ ุงูุฃุณุฆูุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู';
            }
        }

        function updateLoadingStage(stageText, progress = 0, details = '') {
            const currentStage = document.getElementById('currentStage');
            const progressFill = document.getElementById('progressFill');
            const stageDetails = document.getElementById('stageDetails');
            
            if (currentStage) {
                currentStage.innerHTML = stageText;
            }
            
            if (progressFill) {
                progressFill.style.width = `${progress}%`;
            }
            
            if (stageDetails && details) {
                stageDetails.innerHTML = details;
            }
        }

        // Enhanced stage management
        const loadingStages = [
            { text: '๐ ุงูุงุชุตุงู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู...', progress: 10, details: 'ุฌุงุฑู ุงูุงุชุตุงู ุจุฎูุงุฏู Gemini AI' },
            { text: '๐ ุฅุฑุณุงู ุงููุชุทูุจุงุช...', progress: 25, details: 'ุชู ุฅุฑุณุงู ุชูุงุตูู ุงูููุถูุน ูุงููุณุชูู' },
            { text: '๐ง ุชูููุฏ ุงูุฃุณุฆูุฉ...', progress: 50, details: 'ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูููู ุจุฅูุดุงุก ุงูุฃุณุฆูุฉ' },
            { text: '๐ ุชุญููู ูุชูุธูู ุงููุชุงุฆุฌ...', progress: 75, details: 'ูุญุต ุฌูุฏุฉ ุงูุฃุณุฆูุฉ ูุชูุณูููุง' },
            { text: 'โ ุฅููุงุก ุงูุชูุณูู...', progress: 90, details: 'ุฅุถุงูุฉ ุงูููุณุงุช ุงูุฃุฎูุฑุฉ' },
            { text: '๐ ุงูุชูู ุจูุฌุงุญ!', progress: 100, details: 'ุชู ุฅูุดุงุก ุงูุฃุณุฆูุฉ ุจูุฌุงุญ' }
        ];

        async function runLoadingSequence() {
            for (let i = 0; i < loadingStages.length - 1; i++) {
                const stage = loadingStages[i];
                updateLoadingStage(stage.text, stage.progress, stage.details);
                await delay(800 + Math.random() * 400); // Variable delay for realism
            }
        }

        function showLoading(show) {
            showAdvancedLoading(show);
        }

        function showResults() {
            const resultsSection = document.getElementById('resultsSection');
            const aiIndicator = document.getElementById('aiIndicator');
            
            resultsSection.classList.remove('hidden');
            resultsSection.classList.add('success-animation');
            
            if (isAIGenerated) {
                const providerName = aiProvider === 'gemini' ? 'Gemini AI' : aiProvider === 'deepai' ? 'DeepAI' : 'AI';
                const providerIcon = aiProvider === 'gemini' ? '๐ค' : aiProvider === 'deepai' ? '๐ง' : '๐ค';
                aiIndicator.innerHTML = `${providerIcon} ูููุฏ ุจู ${providerName}`;
                aiIndicator.className = 'mr-4 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold';
            } else {
                aiIndicator.innerHTML = 'โ๏ธ ุบูุฑ ูุชุงุญ';
                aiIndicator.className = 'mr-4 px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-semibold';
            }
            
            // Scroll to results
            setTimeout(() => {
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }, 300);
        }

        function hideResults() {
            document.getElementById('resultsSection').classList.add('hidden');
        }

        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorSection.classList.remove('hidden');
            
            // Scroll to error
            setTimeout(() => {
                errorSection.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }

        function showSuccessMessage(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 success-animation';
            successDiv.textContent = message;
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Copy and download functions
        function copyAllQuestions() {
            if (generatedQuestions.length === 0) {
                showError('โ๏ธ ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูููุณุฎ');
                return;
            }

            let text = `ุงูุฃุณุฆูุฉ ุงููููุฏุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู\n`;
            text += `ุงูููุถูุน: ${document.getElementById('subject').value}\n`;
            text += `ุงููุณุชูู: ${document.getElementById('level').value}\n`;
            text += `ุชุงุฑูุฎ ุงูุฅูุดุงุก: ${new Date().toLocaleDateString('ar-SA')}\n`;
            text += `${'='.repeat(50)}\n\n`;
            
            generatedQuestions.forEach((q, index) => {
                text += `${index + 1}. ${q.question}\n`;
                
                if (q.options && q.options.length > 0) {
                    text += `ุงูุฎูุงุฑุงุช:\n`;
                    q.options.forEach(option => {
                        text += `   ${option}\n`;
                    });
                }
                
                if (q.answer) {
                    text += `ุงูุฅุฌุงุจุฉ: ${q.answer}\n`;
                }
                
                if (q.explanation) {
                    text += `ุงูุชูุณูุฑ: ${q.explanation}\n`;
                }
                
                text += `\n${'-'.repeat(30)}\n\n`;
            });

            navigator.clipboard.writeText(text).then(() => {
                showSuccessMessage('โ ุชู ูุณุฎ ุฌููุน ุงูุฃุณุฆูุฉ ุจูุฌุงุญ!');
            }).catch(() => {
                showError('โ ูุดู ูู ูุณุฎ ุงูุฃุณุฆูุฉ');
            });
        }

        function downloadQuestions() {
            if (generatedQuestions.length === 0) {
                showError('โ๏ธ ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ููุชุญููู');
                return;
            }

            let text = `ุงูุฃุณุฆูุฉ ุงููููุฏุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู - Gemini AI\n`;
            text += `ุงูููุถูุน: ${document.getElementById('subject').value}\n`;
            text += `ุงููุณุชูู: ${document.getElementById('level').value}\n`;
            text += `ููุน ุงูุฃุณุฆูุฉ: ${document.getElementById('questionType').value}\n`;
            text += `ุชุงุฑูุฎ ุงูุฅูุดุงุก: ${new Date().toLocaleDateString('ar-SA')}\n`;
            text += `${'='.repeat(60)}\n\n`;
            
            generatedQuestions.forEach((q, index) => {
                text += `ุงูุณุคุงู ${index + 1}:\n${q.question}\n\n`;
                
                if (q.options && q.options.length > 0) {
                    text += `ุงูุฎูุงุฑุงุช:\n`;
                    q.options.forEach(option => {
                        text += `${option}\n`;
                    });
                    text += `\n`;
                }
                
                if (q.answer) {
                    text += `ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: ${q.answer}\n\n`;
                }
                
                if (q.explanation) {
                    text += `ุงูุชูุณูุฑ: ${q.explanation}\n\n`;
                }
                
                text += `${'='.repeat(60)}\n\n`;
            });

            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ุงุณุฆูุฉ_${document.getElementById('subject').value.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showSuccessMessage('โ ุชู ุชุญููู ุงูุฃุณุฆูุฉ ุจูุฌุงุญ!');
        }

        // Exam paper functions
        function createExamPaper() {
            if (generatedQuestions.length === 0) {
                showError('โ๏ธ ูุฑุฌู ุชูููุฏ ุงูุฃุณุฆูุฉ ุฃููุงู');
                return;
            }

            generateExamPaper();
            document.getElementById('examPaperSection').classList.remove('hidden');
            
            setTimeout(() => {
                document.getElementById('examPaperSection').scrollIntoView({ behavior: 'smooth' });
            }, 300);
        }

        function generateExamPaper() {
            const examContent = document.getElementById('examPaperContent');
            const subject = document.getElementById('subject').value;
            const level = document.getElementById('level').value;
            const questionType = document.getElementById('questionType').value;
            const currentDate = new Date().toLocaleDateString('ar-SA');
            const currentTime = new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
            
            // Use custom header settings
            const institutionName = headerSettings.institutionName || 'ุงููุคุณุณุฉ ุงูุชุนููููุฉ';
            const teacherName = headerSettings.teacherName;
            const examDuration = headerSettings.examDuration || 'ุณุงุนุชุงู';
            const questionScore = parseInt(headerSettings.questionScore) || 5;
            const additionalInstructions = headerSettings.additionalInstructions;
            const totalScore = generatedQuestions.length * questionScore;
            
            let html = `
                <div class="exam-paper text-right bg-white" style="font-family: 'Cairo', sans-serif; line-height: 1.6; min-height: 297mm; padding: 20mm;">
                    <!-- Header Section -->
                    <div class="exam-header text-center border-b-2 border-black pb-4 mb-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="text-sm">
                                <p>ุงูุชุงุฑูุฎ: ${currentDate}</p>
                                <p>ุงูููุช: ${currentTime}</p>
                            </div>
                            <div class="text-center flex-1">
                                <h1 class="text-2xl font-bold mb-2">${institutionName}</h1>
                                <h2 class="text-xl font-semibold">ุงูุชุญุงู ูุงุฏุฉ ${subject}</h2>
                                <p class="text-base mt-1">${level} - ${questionType}</p>
                            </div>
                            <div class="text-sm">
                                <p>ุงููุฏุฉ: ${examDuration}</p>
                                <p>ุงูุฏุฑุฌุฉ: ${totalScore}</p>
                            </div>
                        </div>
                        
                        ${teacherName ? `<p class="text-base mb-3"><strong>ุงููุนูู/ุงูุฃุณุชุงุฐ:</strong> ${teacherName}</p>` : ''}
                        
                        <!-- Student Information Box -->
                        <div class="student-info border-2 border-black p-3 mb-4 bg-gray-50">
                            <div class="grid grid-cols-3 gap-4 text-base">
                                <div class="text-right">
                                    <strong>ุงุณู ุงูุทุงูุจ:</strong><br>
                                    <div class="border-b-2 border-black mt-1 h-6"></div>
                                </div>
                                <div class="text-center">
                                    <strong>ุฑูู ุงูุฌููุณ:</strong><br>
                                    <div class="border-b-2 border-black mt-1 h-6 w-20 mx-auto"></div>
                                </div>
                                <div class="text-left">
                                    <strong>ุงููุตู/ุงูุดุนุจุฉ:</strong><br>
                                    <div class="border-b-2 border-black mt-1 h-6"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Instructions Box -->
                        <div class="instructions border border-black p-3 bg-yellow-50 text-right">
                            <h3 class="font-bold mb-2 text-center">๐ ุชุนูููุงุช ุงูุงูุชุญุงู</h3>
                            <div class="text-sm grid grid-cols-2 gap-2">
                                <ul class="space-y-1">
                                    <li>โ ุงูุฑุฃ ุงูุฃุณุฆูุฉ ุจุนูุงูุฉ ูุจู ุงูุฅุฌุงุจุฉ</li>
                                    <li>โ ุฃุฌุจ ุนู ุฌููุน ุงูุฃุณุฆูุฉ ุงููุทููุจุฉ</li>
                                    <li>โ ุงูุชุจ ุจุฎุท ูุงุถุญ ูููุฑูุก</li>
                                    <li>โ ูุง ุชุณุชุฎุฏู ุงูููู ุงูุฑุตุงุต</li>
                                </ul>
                                <ul class="space-y-1">
                                    <li>โ ุชุฃูุฏ ูู ูุชุงุจุฉ ุจูุงูุงุชู ูุงููุฉ</li>
                                    <li>โ ุฑุงุฌุน ุฅุฌุงุจุงุชู ูุจู ุงูุชุณููู</li>
                                    <li>โ ูุง ุชุชุฑู ุฃู ุณุคุงู ุจุฏูู ุฅุฌุงุจุฉ</li>
                                    ${additionalInstructions ? `<li>โ ${additionalInstructions}</li>` : '<li>โ ุญุธุงู ููููุงู</li>'}
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Questions Section -->
                    <div class="questions-section">
            `;

            generatedQuestions.forEach((q, index) => {
                const questionNumber = index + 1;
                html += `
                    <div class="exam-question mb-6 border border-gray-400 rounded p-3" style="page-break-inside: avoid;">
                        <div class="question-header flex items-center mb-3">
                            <div class="bg-blue-600 text-white rounded-full w-7 h-7 flex items-center justify-center font-bold text-sm ml-3">
                                ${questionNumber}
                            </div>
                            <div class="flex-1">
                                <h3 class="text-base font-semibold">${q.question}</h3>
                            </div>
                            <div class="text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded">
                                ${questionScore} ุฏุฑุฌุฉ
                            </div>
                        </div>
                `;

                if (q.options && q.options.length > 0) {
                    html += `<div class="options space-y-2 mr-8">`;
                    q.options.forEach((option, optIndex) => {
                        const optionLetter = String.fromCharCode(65 + optIndex); // A, B, C, D
                        html += `
                            <div class="flex items-center p-1">
                                <div class="border-2 border-gray-500 rounded-full w-4 h-4 ml-3 flex-shrink-0"></div>
                                <span class="font-semibold ml-2">${optionLetter})</span>
                                <span class="text-sm">${option.replace(/^[ุฃ-ุฏ]\)\s*/, '')}</span>
                            </div>
                        `;
                    });
                    html += `</div>`;
                } else if (q.type === 'true_false') {
                    html += `
                        <div class="true-false-options mr-8 flex gap-8">
                            <div class="flex items-center">
                                <div class="border-2 border-gray-500 rounded-full w-4 h-4 ml-2"></div>
                                <span class="font-semibold">ุตุญ</span>
                            </div>
                            <div class="flex items-center">
                                <div class="border-2 border-gray-500 rounded-full w-4 h-4 ml-2"></div>
                                <span class="font-semibold">ุฎุทุฃ</span>
                            </div>
                        </div>
                    `;
                } else {
                    // Essay or short answer questions
                    const lineCount = q.type === 'essay' ? 6 : 3;
                    html += `
                        <div class="answer-space mt-3 mr-8">
                            <p class="text-xs text-gray-600 mb-2">ุงูุฅุฌุงุจุฉ:</p>
                    `;
                    for (let i = 0; i < lineCount; i++) {
                        html += `<div class="border-b border-gray-400 h-6 mb-2"></div>`;
                    }
                    html += `</div>`;
                }

                html += `
                        <!-- Score Box -->
                        <div class="score-box mt-3 pt-2 border-t border-gray-300 flex justify-between items-center">
                            <div class="text-xs text-gray-600">
                                ${q.type === 'multiple_choice' ? 'ุงุฎุชุฑ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ' : 
                                  q.type === 'true_false' ? 'ุถุน ุนูุงูุฉ (โ) ุฃูุงู ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ' : 
                                  'ุฃุฌุจ ุจูุถูุญ ูุฏูุฉ'}
                            </div>
                            <div class="score-area border border-gray-400 px-3 py-1 bg-gray-50">
                                <span class="text-xs">ุงูุฏุฑุฌุฉ: </span>
                                <span class="border-b border-black w-8 inline-block h-4"></span>
                                <span class="text-xs"> / ${questionScore}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                    
                    <!-- Footer Section -->
                    <div class="exam-footer mt-8 pt-4 border-t-2 border-black">
                        <div class="grid grid-cols-3 gap-6 text-base">
                            <!-- Total Score Section -->
                            <div class="text-center border border-black p-3 bg-blue-50">
                                <h4 class="font-bold mb-2">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ</h4>
                                <div class="text-lg">
                                    <span>ุงููุฌููุน: </span>
                                    <span class="border-b-2 border-black w-12 inline-block h-6"></span>
                                    <span> / ${totalScore}</span>
                                </div>
                                <div class="mt-2">
                                    <span>ุงููุณุจุฉ ุงููุฆููุฉ: </span>
                                    <span class="border-b-2 border-black w-12 inline-block h-6"></span>
                                    <span>%</span>
                                </div>
                            </div>
                            
                            <!-- Grade Section -->
                            <div class="text-center border border-black p-3 bg-green-50">
                                <h4 class="font-bold mb-2">ุงูุชูุฏูุฑ</h4>
                                <div class="space-y-1 text-sm">
                                    <div>โก ููุชุงุฒ (90-100%)</div>
                                    <div>โก ุฌูุฏ ุฌุฏุงู (80-89%)</div>
                                    <div>โก ุฌูุฏ (70-79%)</div>
                                    <div>โก ููุจูู (60-69%)</div>
                                    <div>โก ุถุนูู (ุฃูู ูู 60%)</div>
                                </div>
                            </div>
                            
                            <!-- Signatures Section -->
                            <div class="text-center border border-black p-3 bg-yellow-50">
                                <h4 class="font-bold mb-2">ุงูุชูููุนุงุช</h4>
                                <div class="space-y-3">
                                    <div>
                                        <p class="text-sm">ุงููุตุญุญ:</p>
                                        <div class="border-b border-black h-6 mt-1"></div>
                                    </div>
                                    <div>
                                        <p class="text-sm">ุงููุฑุงุฌุน:</p>
                                        <div class="border-b border-black h-6 mt-1"></div>
                                    </div>
                                    <div>
                                        <p class="text-sm">ุชุงุฑูุฎ ุงูุชุตุญูุญ:</p>
                                        <div class="border-b border-black h-6 mt-1"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bottom Note -->
                        <div class="text-center mt-4 text-xs text-gray-600 border-t border-gray-300 pt-2">
                            <p>ุชู ุฅูุดุงุก ูุฐุง ุงูุงูุชุญุงู ุจูุงุณุทุฉ ูููุฏ ุงูุฃุณุฆูุฉ ุงูุฐูู โข ${currentDate} โข ${institutionName}</p>
                        </div>
                    </div>
                </div>
            `;

            examContent.innerHTML = html;
        }

        function printExam() {
            window.print();
        }

        function downloadExamPDF() {
            const subject = document.getElementById('subject').value;
            const level = document.getElementById('level').value;
            const currentDate = new Date().toLocaleDateString('ar-SA');
            
            let examText = `ุงูุชุญุงู ูุงุฏุฉ ${subject}\n`;
            examText += `ุงููุณุชูู: ${level}\n`;
            examText += `ุงูุชุงุฑูุฎ: ${currentDate}\n`;
            examText += `ุงููุฏุฉ: ุณุงุนุชุงู\n`;
            examText += `ุงูุฏุฑุฌุฉ ุงููููุฉ: ${generatedQuestions.length * 5} ุฏุฑุฌุฉ\n\n`;
            examText += `${'='.repeat(60)}\n\n`;
            
            examText += `ุงุณู ุงูุทุงูุจ: ________________________________\n`;
            examText += `ุฑูู ุงูุฌููุณ: ________________________________\n\n`;
            
            examText += `ุชุนูููุงุช ุงูุงูุชุญุงู:\n`;
            examText += `โข ุงูุฑุฃ ุงูุฃุณุฆูุฉ ุจุนูุงูุฉ ูุจู ุงูุฅุฌุงุจุฉ\n`;
            examText += `โข ุฃุฌุจ ุนู ุฌููุน ุงูุฃุณุฆูุฉ\n`;
            examText += `โข ุงูุชุจ ุจุฎุท ูุงุถุญ ูููุฑูุก\n\n`;
            examText += `${'='.repeat(60)}\n\n`;
            
            generatedQuestions.forEach((q, index) => {
                examText += `${index + 1}. ${q.question}\n\n`;
                
                if (q.options && q.options.length > 0) {
                    q.options.forEach(option => {
                        examText += `   โ ${option}\n`;
                    });
                } else {
                    examText += `   ุงูุฅุฌุงุจุฉ:\n`;
                    examText += `   ${'_'.repeat(50)}\n`;
                    examText += `   ${'_'.repeat(50)}\n`;
                    examText += `   ${'_'.repeat(50)}\n`;
                }
                
                examText += `\n   ุงูุฏุฑุฌุฉ: _____ / 5\n\n`;
                examText += `${'-'.repeat(60)}\n\n`;
            });
            
            examText += `ุงููุฌููุน ุงูููู: _____ / ${generatedQuestions.length * (parseInt(headerSettings.questionScore) || 5)} ุฏุฑุฌุฉ\n`;
            examText += `ุงูุชูุฏูุฑ: ________________________\n`;
            examText += `ุชูููุน ุงููุตุญุญ: ________________________\n`;

            const blob = new Blob([examText], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ุงูุชุญุงู_${subject.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showSuccessMessage('โ ุชู ุชุญููู ูุฑูุฉ ุงูุงูุชุญุงู ุจูุฌุงุญ!');
        }

        // Edit Questions Functions
        function editQuestions() {
            if (generatedQuestions.length === 0) {
                showError('โ๏ธ ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ููุชุนุฏูู');
                return;
            }

            const container = document.getElementById('editQuestionsContainer');
            container.innerHTML = '';

            generatedQuestions.forEach((q, index) => {
                const editDiv = document.createElement('div');
                editDiv.className = 'border border-gray-300 rounded-lg p-4';
                
                let optionsHtml = '';
                if (q.options && q.options.length > 0) {
                    optionsHtml = `
                        <div class="mt-3">
                            <label class="block text-gray-700 font-semibold mb-2">ุงูุฎูุงุฑุงุช:</label>
                            ${q.options.map((option, optIndex) => `
                                <input type="text" value="${option}" 
                                       class="w-full p-2 border border-gray-300 rounded mb-2 edit-option" 
                                       data-question="${index}" data-option="${optIndex}">
                            `).join('')}
                        </div>
                    `;
                }

                editDiv.innerHTML = `
                    <div class="mb-3">
                        <label class="block text-gray-700 font-semibold mb-2">ุงูุณุคุงู ${index + 1}:</label>
                        <textarea class="w-full p-3 border border-gray-300 rounded-lg edit-question" 
                                  data-question="${index}" rows="2">${q.question}</textarea>
                    </div>
                    ${optionsHtml}
                    <div class="mt-3">
                        <label class="block text-gray-700 font-semibold mb-2">ุงูุฅุฌุงุจุฉ:</label>
                        <textarea class="w-full p-2 border border-gray-300 rounded edit-answer" 
                                  data-question="${index}" rows="2">${q.answer}</textarea>
                    </div>
                    <div class="mt-3">
                        <label class="block text-gray-700 font-semibold mb-2">ุงูุชูุณูุฑ:</label>
                        <textarea class="w-full p-2 border border-gray-300 rounded edit-explanation" 
                                  data-question="${index}" rows="2">${q.explanation}</textarea>
                    </div>
                `;

                container.appendChild(editDiv);
            });

            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        function saveEditedQuestions() {
            const editQuestions = document.querySelectorAll('.edit-question');
            const editAnswers = document.querySelectorAll('.edit-answer');
            const editExplanations = document.querySelectorAll('.edit-explanation');
            const editOptions = document.querySelectorAll('.edit-option');

            // Update questions
            editQuestions.forEach((input, index) => {
                if (generatedQuestions[index]) {
                    generatedQuestions[index].question = input.value;
                }
            });

            // Update answers
            editAnswers.forEach((input, index) => {
                if (generatedQuestions[index]) {
                    generatedQuestions[index].answer = input.value;
                }
            });

            // Update explanations
            editExplanations.forEach((input, index) => {
                if (generatedQuestions[index]) {
                    generatedQuestions[index].explanation = input.value;
                }
            });

            // Update options
            editOptions.forEach(input => {
                const questionIndex = parseInt(input.dataset.question);
                const optionIndex = parseInt(input.dataset.option);
                if (generatedQuestions[questionIndex] && generatedQuestions[questionIndex].options) {
                    generatedQuestions[questionIndex].options[optionIndex] = input.value;
                }
            });

            // Refresh display
            displayQuestions(generatedQuestions);
            closeEditModal();
            showSuccessMessage('โ ุชู ุญูุธ ุงูุชุนุฏููุงุช ุจูุฌุงุญ!');
        }

        // Format Functions
        function formatQuestions() {
            if (generatedQuestions.length === 0) {
                showError('โ๏ธ ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ููุชูุณูู');
                return;
            }

            document.getElementById('formatModal').classList.remove('hidden');
        }

        function closeFormatModal() {
            document.getElementById('formatModal').classList.add('hidden');
        }

        function applyFormatting() {
            const displayStyle = document.getElementById('displayStyle').value;
            const fontSize = document.getElementById('fontSize').value;
            const borderColor = document.getElementById('borderColor').value;
            const showNumbers = document.getElementById('showNumbers').checked;
            const showExplanations = document.getElementById('showExplanations').checked;

            const container = document.getElementById('questionsContainer');
            const questionCards = container.querySelectorAll('.question-card');

            questionCards.forEach((card, index) => {
                // Apply display style
                if (displayStyle === 'list') {
                    card.className = `question-card bg-white p-4 border-b border-gray-200 ${fontSize}`;
                } else if (displayStyle === 'compact') {
                    card.className = `question-card bg-gray-50 p-3 rounded border ${borderColor} ${fontSize}`;
                } else {
                    card.className = `question-card bg-gray-50 p-6 rounded-lg border-r-4 ${borderColor} ${fontSize}`;
                }

                // Show/hide numbers
                const numberElement = card.querySelector('.bg-gradient-to-r');
                if (numberElement) {
                    numberElement.style.display = showNumbers ? 'flex' : 'none';
                }

                // Show/hide explanations
                const explanationElement = card.querySelector('.bg-yellow-50');
                if (explanationElement) {
                    explanationElement.style.display = showExplanations ? 'block' : 'none';
                }
            });

            closeFormatModal();
            showSuccessMessage('๐จ ุชู ุชุทุจูู ุงูุชูุณูู ุจูุฌุงุญ!');
        }

        // Header Customization Functions
        let headerSettings = {
            institutionName: 'ุงููุคุณุณุฉ ุงูุชุนููููุฉ',
            teacherName: '',
            examDuration: 'ุณุงุนุชุงู',
            questionScore: '5',
            additionalInstructions: ''
        };

        function customizeHeader() {
            // Load current settings into modal
            document.getElementById('institutionName').value = headerSettings.institutionName;
            document.getElementById('teacherName').value = headerSettings.teacherName;
            document.getElementById('examDuration').value = headerSettings.examDuration;
            document.getElementById('questionScore').value = headerSettings.questionScore;
            document.getElementById('additionalInstructions').value = headerSettings.additionalInstructions;
            
            document.getElementById('headerModal').classList.remove('hidden');
        }

        function closeHeaderModal() {
            document.getElementById('headerModal').classList.add('hidden');
        }

        function saveHeaderSettings() {
            headerSettings.institutionName = document.getElementById('institutionName').value || 'ุงููุคุณุณุฉ ุงูุชุนููููุฉ';
            headerSettings.teacherName = document.getElementById('teacherName').value;
            headerSettings.examDuration = document.getElementById('examDuration').value;
            headerSettings.questionScore = document.getElementById('questionScore').value;
            headerSettings.additionalInstructions = document.getElementById('additionalInstructions').value;

            closeHeaderModal();
            showSuccessMessage('๐ ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุชุฑููุณุฉ ุจูุฌุงุญ!');
            
            // If exam paper is visible, regenerate it with new settings
            if (!document.getElementById('examPaperSection').classList.contains('hidden')) {
                generateExamPaper();
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Add enter key support
            document.getElementById('subject').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    generateQuestions();
                }
            });
            
            console.log('ูููุฏ ุงูุฃุณุฆูุฉ ุงูุฐูู ุฌุงูุฒ ููุงุณุชุฎุฏุงู!');
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96d09b9ac41f5cd2',t:'MTc1NDg0MDU5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
